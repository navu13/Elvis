# Проверка файлов изображений Orphea

Этот тест остается пока незавершенным, так как, во-первых, метод быстрой проверки пока не найден и, во-вторых, не до конца исследована методика тестирования, особенно, испорченных файлов и файлов с некорректными цветовыми профилями. С ними надо создать свой рабочий процесс для устранения ошибок.

## Идея реализации

Elvis использует для генерации preview библиотеку [GraphicsMagick](http://www.graphicsmagick.org), поэтому рекомендуется установить ее (для Windows скачивать нужное со словами dll, все равно там есть exe). Но там сложнее отлавливать ошибки, поэтому пока используется [ImageMagick](http://www.imagemagick.org).

Генерируется превью размера 32px по большей стороне, в ходе генерации выводится информация о любых проблемах, причем в довольно удобно читаемой форме.

В программе информация типа Warning выводится в поток сообщений об ошибках (ключ -regard-warnings).
Если ошибки (err) есть, выводится информация из stderr, иначе файл считается корректным.

На момент написания тестировались форматы jpg и tif.

image\_integrity\_check.js – для работы непосредственно с Orphea  
image\_integrity\_check\_uno.js – для работы c локальными файлами

Результаты работы программы записываются в папку logs в файлы
success.log – для удачно сгенерированных превью
fail.log – для превью, сгенерированных с ошибками
missing.log – для отсутствующих файлов

## Параметры строки генерации

### Строка в скрипте 

convert ${row.AX_FILE_PATH} -regard-warnings -resize 32x32 preview.jpg

convert – команда GraphicsMagick для конвертации
-regard-warning – ключ перенаправления предупреждений в поток ошибок
-resize 32x32 – масштабирование в размер по большей стороне
preview.jpg – результирующий файл

### Дополнительные параметры, используемые Elvis

convert -limit disk 8GiB -matte -background #ffffff ${row.AX\_FILE\_PATH} -resize 1600x1600 -quality 75 -profile /srv/elvis-server/app/tools/shared/adobe/icc/sRGB/sRGB\_IEC61966-2-1\_black_scaled.icc -colorspace RGB -strip preview.jpg

-limit disk 8GiB – ограничение по ресурсам, в нашем случае необязательно
-matte – что-то вроде alpha-канала, в нашем случае необязательно
-background #ffffff – генерация фона
-quality 75 – установка качества, в нашем случае необязательно
-profile path_to.icc – конвертация в единый профиль для корректного отображения цвета в интерфейсе
-colorspace RGB – перевод в RGB-пространство, если требуется
-strip – удаление всех профилей (как цветовых, так и прочих) и текстовых атрибутов

## Развитие

### Цветовые профили

Сохранение цветового профиля на диск
convert image.jpg profile.icc

Удаление цветового профиля
convert image.jpg +profile "icm" converted.jpg

В ImageMagick ошибка Abort trap: 6 может как раз соответствовать ошибке в профиле
